# README: Утилита для опроса счетчиков ТЭМ-104

## Описание

Данная программа предназначена для опроса и чтения данных с теплосчетчиков семейства ТЭМ-104 различных модификаций (ARVAS, TESMART и др.) через локальный COM-порт или по сети TCP/IP (через модем). Программа автоматически определяет модель счетчика, выбирает соответствующий протокол обмена и выводит основные параметры: время, накопленные итоги (объем, масса, энергия), мгновенные параметры (температуры, мощность).

## Возможности

- Поддержка нескольких протоколов и моделей ТЭМ-104 (ARVAS_LEGACY, ARVAS_LEGACY_1, TESMART, ARVAS_M, ARVAS_M1)
- Работа через COM-порт и TCP/IP
- Автоматическое определение протокола по ответу счетчика
- Чтение и разбор времени, накопленных итогов, мгновенных параметров
- Подробный вывод в консоль для диагностики

## Запуск

1. Установите зависимости (pyserial для работы с COM-портом):

   ```
   pip install pyserial
   ```

2. Запустите программу:

   ```
   python test104.py
   ```

3. Следуйте интерактивным подсказкам для выбора типа подключения и ввода параметров.

---

# Описание структуры и логики кода

## 1. Константы и вспомогательные функции

- **Константы протокола**: определяют управляющие байты, группы команд и коды команд для формирования пакетов обмена.
- **print_hex**: удобная функция для вывода байтовых данных в HEX-формате (для отладки).
- **bcd_to_int**: преобразует байт в формате BCD в целое число.

## 2. Базовый класс протокола (`TEM104_Base_Client`)

### Обзор

Этот класс реализует всю логику формирования и разбора пакетов, а также маршрутизацию команд в зависимости от типа протокола. Не зависит от транспорта (COM или TCP).

### Основные методы

- **__init__**: инициализация адреса и типа протокола.
- **connect / disconnect**: абстрактные методы для подключения/отключения (реализуются в дочерних классах).
- **_send_and_receive**: абстрактный метод отправки пакета и получения ответа.
- **_create_packet**: формирует пакет запроса по протоколу.
- **auto_detect_protocol**: отправляет команду идентификации и определяет модель счетчика по ответу.
- **read_all_data**: основной маршрутизатор, вызывает нужные методы чтения в зависимости от протокола.
- **_read_arvas_m1_data, _read_arvas_m_data, _read_arvas_legacy_1_data, _read_arvas_legacy_data, _read_tesmart_data**: методы чтения данных для каждой модели/протокола.
- **_read_rtc_decimal, _read_rtc_bcd**: чтение времени (в десятичном или BCD-формате).
- **_read_totals**: чтение накопленных итогов (объем, масса, энергия).
- **_read_instantaneous**: чтение мгновенных параметров (температуры, мощность).
- **_parse_tesmart_payload**: разбор большого блока данных для протокола TESMART.
- **_get_tesmart_coeff**: получение коэффициентов для пересчёта данных TESMART.

## 3. Класс для работы через COM-порт (`TEM104_Serial_Client`)

### Обзор

Реализует транспортный уровень для локального подключения через COM-порт.

### Основные методы

- **__init__**: инициализация параметров порта.
- **connect**: открытие COM-порта.
- **disconnect**: закрытие порта.
- **_send_and_receive**: отправка пакета и получение ответа через последовательный порт, проверка контрольной суммы и структуры ответа.

## 4. Класс для работы через TCP/IP (`TEM104_TCP_Client`)

### Обзор

Реализует транспортный уровень для подключения по сети (например, через GSM-модем).

### Основные методы

- **__init__**: инициализация параметров подключения.
- **connect**: установка TCP-соединения.
- **disconnect**: закрытие соединения.
- **_send_and_receive**: отправка пакета и получение ответа по TCP, проверка контрольной суммы и структуры ответа.

## 5. Главная функция (`main`)

### Обзор

Запускает интерактивное меню для пользователя, позволяет выбрать тип подключения, ввести параметры, создать нужный клиент, подключиться, опросить счетчик и вывести результаты.

### Логика

- Запрашивает у пользователя тип подключения (COM или TCP/IP).
- Запрашивает параметры подключения (порт, скорость, адрес или IP, TCP-порт, адрес).
- Создаёт соответствующий клиент.
- Подключается, опрашивает счетчик, выводит данные.
- Корректно закрывает соединение при завершении или ошибке.

---

# Описание логики работы с разными протоколами

## Автоматическое определение протокола

- Программа отправляет команду идентификации.
- По строке-ответу определяет модель счетчика и выбирает нужный протокол.

## Особенности протоколов

- **ARVAS_M1, ARVAS_M**: новые модели, данные хранятся в десятичном формате, адресация и структура памяти отличаются.
- **ARVAS_LEGACY, ARVAS_LEGACY_1**: старые модели, данные времени хранятся в BCD, структура памяти и смещения другие.
- **TESMART**: особый протокол, данные читаются большими блоками, требуется разбор коэффициентов для пересчёта итогов.

## Чтение данных

- Для каждой модели вызываются свои методы чтения времени, накопленных итогов и мгновенных параметров с учётом особенностей адресации и формата хранения данных.

---

# Пример вывода

```
--- Утилита для опроса счетчиков ТЭМ-104 ---
Как вы хотите подключиться?
 1 - Локальный COM-порт
 2 - Сеть TCP/IP (модем)
Ваш выбор: 1
Введите имя COM-порта (например, COM3): COM3
Введите скорость (9600, 19200 и т.д.) [9600]: 9600
Введите сетевой адрес счетчика [1]: 1
Попытка подключения к COM3 со скоростью 9600...
Порт успешно открыт.

--- 1. Автоматическое определение протокола ---
Устройство ответило: 'TEM-104M-1'
Используется протокол: ARVAS_M1

--- 2a. Чтение времени (Decimal) ---
Успешно: Текущее время: 2024-06-01 12:34:56

--- 2b. Чтение накопленных итогов ---
Успешно: Накопленные итоги прочитаны.
  Объем (V, м³): 123.456
  Масса (M, т): 78.900
  Энергия (Q, Гкал/МВт*ч): 12.3456

--- 2c. Чтение мгновенных параметров ---
Успешно: Мгновенные параметры прочитаны.
  Температуры (°C): ['65.12', '45.34']
  Мощность (Гкал/ч): 0.1234
```

---

# Комментарии к коду

Весь код снабжён подробными комментариями на русском языке, поясняющими назначение функций, классов и блоков кода. Каждый метод содержит docstring с описанием его работы.

---

Если нужно добавить примеры использования, расширить описание или сделать отдельную документацию по каждому протоколу — дайте знать! 

---

# Структура кода с комментариями и секциями

```python
# -*- coding: utf-8 -*-
"""
Скрипт для опроса и чтения данных с теплосчетчиков ТЭМ-104 различных моделей (ARVAS, TESMART и др.)
Работает через COM-порт или TCP/IP, автоматически определяет модель счетчика и протокол, выводит основные параметры.
"""

# 1. Импорт библиотек и константы
# Импортируются необходимые модули и определяются константы протокола
import socket
import serial
import time
import struct
from typing import Optional, Literal

# --- КОНСТАНТЫ ПРОТОКОЛА ---
REQUEST_START_BYTE = 0x55      # Стартовый байт запроса (от мастера к счетчику)
RESPONSE_START_BYTE = 0xAA     # Стартовый байт ответа (от счетчика к мастеру)
CMD_GROUP_CONNECTION = 0x00    # Группа команд: соединение/идентификация
CMD_GROUP_READ_MEM = 0x0F      # Группа команд: чтение памяти (EEPROM)
CMD_GROUP_READ_RAM = 0x0C      # Группа команд: чтение ОЗУ (RAM)
CMD_IDENTIFY = 0x00            # Команда: идентификация устройства
CMD_READ_CONFIG = 0x01         # Команда: чтение конфигурации/итогов
CMD_READ_RTC = 0x02            # Команда: чтение времени (RTC)
CMD_READ_RAM = 0x01            # Команда: чтение мгновенных параметров (RAM)

ProtocolType = Literal[
    'ARVAS_LEGACY',     # Старый протокол TEM-104
    'ARVAS_LEGACY_1',   # TEM-104-1 (усовершенствованный старый)
    'TESMART',          # Протокол ТЭСМАРТ (TSM104)
    'ARVAS_M',          # TEM-104M (новый протокол)
    'ARVAS_M1'          # TEM-104M-1 (самый новый протокол)
]

# 2. Вспомогательные функции
# Функции для вывода данных и преобразования форматов

def print_hex(data: bytes or bytearray, prefix: str = ""):
    """Удобная функция для печати байт в HEX-формате."""
    print(f"{prefix}{' '.join(f'{b:02X}' for b in data)}")

def bcd_to_int(bcd_byte: int) -> int:
    """Преобразует один байт BCD в integer."""
    return (bcd_byte >> 4) * 10 + (bcd_byte & 0x0F)

# 3. Базовый класс протокола
# Содержит логику формирования и разбора пакетов, маршрутизацию команд по протоколам

class TEM104_Base_Client:
    ...
    # --- Методы чтения данных для разных протоколов ---
    def _read_arvas_m1_data(self): ...
    def _read_arvas_m_data(self): ...
    def _read_arvas_legacy_1_data(self): ...
    def _read_arvas_legacy_data(self): ...
    def _read_tesmart_data(self): ...
    # --- Методы разбора и чтения отдельных блоков данных ---
    def _parse_tesmart_payload(self, payload: bytes): ...
    def _read_rtc_decimal(self): ...
    def _read_rtc_bcd(self): ...
    def _read_totals(self, command: int, base_addr: int, offsets: dict): ...
    def _read_instantaneous(self, base_addr: int, offsets: dict, num_temps: int): ...
    @staticmethod
    def _get_tesmart_coeff(comma_val: int, param_type: str) -> int: ...

# 4. Класс для работы через COM-порт
# Реализует транспортный уровень для локального подключения через COM-порт

class TEM104_Serial_Client(TEM104_Base_Client):
    ...

# 5. Класс для работы через TCP/IP
# Реализует транспортный уровень для подключения по сети (например, через GSM-модем)

class TEM104_TCP_Client(TEM104_Base_Client):
    ...

# 6. Главная функция и запуск
# Запускает интерактивное меню, создает клиента, опрашивает счетчик и выводит данные

def main():
    ...

if __name__ == "__main__":
    main()
``` 